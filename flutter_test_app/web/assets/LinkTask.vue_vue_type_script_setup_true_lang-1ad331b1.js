import{d as A,r as w,a2 as S,t as I,o as b,c as V,f as e,w as o,g as f,e as h,i as v,$ as j,ac as z,m as O,j as C,E as D,k as H}from"./index-0207282d.js";import{E as M,a as q}from"./el-form-item-cffcfafd.js";import{E as G,a as J}from"./el-table-column-def74e1d.js";import"./el-checkbox-816fe3b3.js";import"./el-tooltip-4ed993c7.js";import"./el-popper-90f9afbe.js";import"./el-tag-0efdc75d.js";/* empty css                 */import{E as K,a as P}from"./el-select-69ed96fa.js";/* empty css                  */const Q={class:"flex-center-x py-2 w-full"},W=h("div",{class:"flex-1"},"关联任务列表",-1),X={class:"flex-center mt-6"},me=A({__name:"LinkTask",props:{row:{type:Object,default:()=>({})}},emits:["close"],setup(L,{emit:g}){const N=L,E=w(),i=w({activityName:"",taskVoList:[]});S(()=>{i.value={...N.row,taskVoList:[...N.row.taskVoList]}});const T=()=>{i.value.taskVoList.push({taskNo:"",taskName:"",targetType:1,taskRewardCoin:"",taskRewardAmount:"",createTimeTemp:0})},R=t=>{i.value.taskVoList.splice(t,1)},x=t=>{const{taskNo:s,taskName:r,targetType:l,taskRewardCoin:u,taskRewardAmount:n}=y.value.find(p=>p.taskNo===t.taskNo)||{};t.taskNo=s,t.taskName=r,t.targetType=l||1,t.taskRewardCoin=u,t.taskRewardAmount=n},$=t=>{const s=i.value.taskVoList.filter((r,l)=>l!==t)||[];return y.value.filter(r=>!s.some(l=>l.taskNo===r.taskNo))},k=w(!1),F=async()=>{try{k.value=!0,await C.post("/activity/relative/task",{activityNo:N.row.activityNo,taskList:i.value.taskVoList.filter(t=>t.taskNo&&t.targetType)}),g("close",!0)}finally{k.value=!1}},y=w([]);I(()=>{C.post("/task/page",{num:1,size:1e4}).then(t=>{y.value=t.content||[]})});const B=t=>{const{columns:s,data:r}=t,l=[];return s.forEach((u,n)=>{var m;if(n===0){l[n]="总计奖励数量";return}const p=r.map(c=>Number(c[u.property]));p.every(c=>Number.isNaN(c))||(l[n]=`${p.reduce((c,_)=>{const a=Number(_);return Number.isNaN(a)?c:c+_},0)} ${(m=r[0])==null?void 0:m.taskRewardCoin}`)}),l};return(t,s)=>{const r=D,l=M,u=H,n=K,p=P,m=G,c=J,_=q;return b(),V("div",null,[e(_,{ref_key:"formRef",ref:E,model:f(i),"label-width":"140px","label-position":"left"},{default:o(()=>[e(l,{label:"活动名称",prop:"activityName"},{default:o(()=>[e(r,{modelValue:f(i).activityName,"onUpdate:modelValue":s[0]||(s[0]=a=>f(i).activityName=a),readonly:""},null,8,["modelValue"])]),_:1}),e(l,{"label-width":"0"},{default:o(()=>[h("div",Q,[W,e(u,{type:"primary",onClick:T},{default:o(()=>[v("添加")]),_:1})]),e(c,{data:f(i).taskVoList,class:"w-full",stripe:"","show-summary":"","summary-method":B},{default:o(()=>[e(m,{label:"任务ID","min-width":"120",align:"center","show-overflow-tooltip":""},{default:o(a=>[e(p,{modelValue:a.row.taskNo,"onUpdate:modelValue":d=>a.row.taskNo=d,placeholder:"Select",class:"w-full",onChange:d=>x(a.row)},{default:o(()=>[(b(!0),V(j,null,z($(a.$index),(d,U)=>(b(),O(n,{key:U,label:d.taskNo,value:d.taskNo},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),e(m,{label:"任务名称",prop:"taskName","min-width":"80",align:"center","show-overflow-tooltip":""}),e(m,{label:"生效类型","min-width":"100",align:"center","show-overflow-tooltip":""},{default:o(a=>[e(p,{modelValue:a.row.targetType,"onUpdate:modelValue":d=>a.row.targetType=d,placeholder:"Select",class:"w-full"},{default:o(()=>[e(n,{label:"活动期间",value:1}),e(n,{label:"活动之前",value:2}),e(n,{label:"全员福利",value:3})]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:1}),e(m,{label:"奖励币种",prop:"taskRewardCoin","min-width":"80",align:"center","show-overflow-tooltip":""}),e(m,{label:"奖励数量",prop:"taskRewardAmount","min-width":"80",align:"center","show-overflow-tooltip":""}),e(m,{label:"操作","min-width":"60",align:"center","show-overflow-tooltip":""},{default:o(a=>[e(u,{type:"danger",size:"small",plain:"",onClick:d=>R(a.$index)},{default:o(()=>[v("删除")]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})]),_:1},8,["model"]),h("div",X,[e(u,{type:"info",disabled:f(k),onClick:s[1]||(s[1]=a=>g("close"))},{default:o(()=>[v("关闭")]),_:1},8,["disabled"]),e(u,{type:"primary",loading:f(k),onClick:F},{default:o(()=>[v("保存")]),_:1},8,["loading"])])])}}});export{me as _};
